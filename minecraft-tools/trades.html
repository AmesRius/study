<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>æ‘äººäº¤æ˜“å›³é‘‘</title>
<style>
  :root{
    --bg:#071027; --card:#0a1220; --muted:#9fb0c2; --accent:#6ee7b7;
    font-family: "Inter","Noto Sans JP", system-ui, -apple-system, "Hiragino Kaku Gothic ProN","Yu Gothic", Meiryo, Arial;
  }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#03101a,#071827);color:#eaf6f2}
  .wrap{max-width:1100px;margin:0 auto;padding:12px}
  header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
  h1{margin:0;font-size:18px}
  p.subtitle{margin:0;color:var(--muted);font-size:13px}

  /* toolbar */
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0}
  .btn{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.04);padding:8px 10px;border-radius:10px;color:var(--accent);font-weight:700;cursor:pointer}
  .btn.ghost{color:var(--muted);border-style:dashed}
  .input{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:rgba(255,255,255,0.02);color:inherit}

  /* layout */
  .main{display:flex;gap:12px}
  .sidebar{width:240px;min-width:180px}
  .panel{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
  .job-list{display:flex;flex-direction:column;gap:8px;max-height:60vh;overflow:auto}
  .job-item{padding:8px;border-radius:8px;cursor:pointer;background:transparent;border:1px solid transparent}
  .job-item.active{background:rgba(255,255,255,0.02);border-color:rgba(255,255,255,0.04);color:var(--accent);font-weight:700}

  .content{flex:1;display:flex;flex-direction:column;gap:10px}
  .levels{display:flex;gap:6px;flex-wrap:wrap}
  .level-btn{padding:6px 8px;border-radius:999px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);cursor:pointer;color:var(--muted)}
  .level-btn.active{background:var(--accent);color:#042; font-weight:700}

  .columns{display:flex;gap:12px}
  .col{flex:1;background:rgba(255,255,255,0.02);padding:10px;border-radius:10px;min-height:150px}
  .col h3{margin:0 0 8px 0}
  .item{display:flex;gap:10px;align-items:center;padding:8px;border-radius:8px;margin-bottom:8px;background:rgba(255,255,255,0.01)}
  .thumb{width:48px;height:48px;border-radius:8px;object-fit:cover;background:rgba(0,0,0,0.2)}
  .itmeta{flex:1}
  .itmeta .name{font-weight:700}
  .itmeta .sub{color:var(--muted);font-size:13px;margin-top:4px}
  .it-actions{display:flex;gap:6px}
  .smallbtn{padding:6px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--muted);cursor:pointer}

  /* footer controls */
  .json-area{margin-top:10px;display:flex;gap:8px;flex-direction:column}
  textarea#jsonInput{min-height:120px;border-radius:8px;padding:8px;border:1px solid rgba(255,255,255,0.04);background:rgba(0,0,0,0.2);color:inherit}

  /* modal */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;padding:20px;z-index:60}
  .modal.open{display:flex}
  .card{background:#071827;padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);max-width:640px;width:100%}
  .row{display:flex;gap:8px;align-items:center;margin-bottom:8px;flex-wrap:wrap}
  label{color:var(--muted);font-size:13px}
  input[type="text"].small,input[type="url"].small{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:rgba(255,255,255,0.02);color:inherit}

  /* responsive */
  @media(max-width:900px){
    .main{flex-direction:column}
    .sidebar{width:100%}
    .levels{overflow:auto}
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>ğŸ§‘â€ğŸŒ¾ æ‘äººäº¤æ˜“å›³é‘‘</h1>
      <p class="subtitle">è·æ¥­ãƒ»ãƒ¬ãƒ™ãƒ«åˆ¥ã«ã€Œå£²ã‚‹ã‚‚ã®ã€ã€Œè²·ãˆã‚‹ã‚‚ã®ã€ã‚’å·¦å³ã§ç¢ºèªï¼ˆJSONèª­ã¿è¾¼ã¿ã§ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯ï¼‰</p>
    </div>
  </header>

  <div class="toolbar">
    <input id="search" class="input" placeholder="æ¤œç´¢ï¼šè·æ¥­ / ãƒ¬ãƒ™ãƒ« / ã‚¢ã‚¤ãƒ†ãƒ å" style="min-width:240px" />
    <button class="btn ghost" id="loadSample">ã‚µãƒ³ãƒ—ãƒ«èª­ã¿è¾¼ã¿</button>
    <label class="btn ghost" style="display:inline-flex;align-items:center;gap:8px">
      JSONèª­ã¿è¾¼ã¿
      <input id="fileInput" type="file" accept=".json" style="display:none">
    </label>
    <button class="btn" id="pasteJsonBtn">è²¼ã‚Šä»˜ã‘ã‹ã‚‰èª­ã¿è¾¼ã‚€</button>
    <button class="btn" id="exportJson">JSONã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
    <button class="btn ghost" id="clearAll">å…¨ã¦ã‚¯ãƒªã‚¢</button>
  </div>

  <div class="main">
    <aside class="sidebar">
      <div class="panel">
        <div style="font-weight:700;margin-bottom:8px">è·æ¥­ä¸€è¦§</div>
        <div class="job-list" id="jobList"></div>
        <div style="margin-top:10px;color:var(--muted);font-size:13px">è·æ¥­ã‚’é¸ã‚“ã§ãƒ¬ãƒ™ãƒ«ã‚’è¡¨ç¤ºã—ã¾ã™</div>
      </div>
    </aside>

    <section class="content">
      <div class="panel" style="display:flex;flex-direction:column;gap:8px">
        <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
          <div style="font-weight:700" id="currentJobLabel">è·æ¥­ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
          <div class="levels" id="levelTabs"></div>
          <div style="margin-left:auto;color:var(--muted)" id="countInfo"></div>
        </div>

        <div class="columns">
          <div class="col" id="sellCol">
            <h3>å£²ã‚‹ã‚‚ã® â†’ ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰</h3>
            <div id="sellList"></div>
          </div>
          <div class="col" id="buyCol">
            <h3>ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰ã§è²·ãˆã‚‹ã‚‚ã®</h3>
            <div id="buyList"></div>
          </div>
        </div>

        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button class="btn ghost" id="openImgMap">ç”»åƒãƒãƒƒãƒ”ãƒ³ã‚°</button>
          <button class="btn ghost" id="copyView">è¡¨ç¤ºã‚’ã‚³ãƒ”ãƒ¼</button>
        </div>
      </div>

      <div class="panel json-area">
        <div style="display:flex;gap:8px;align-items:center;justify-content:space-between">
          <div style="font-weight:700">JSONï¼ˆè²¼ã‚Šä»˜ã‘ã¦èª­ã¿è¾¼ã¿ / ç·¨é›† â†’ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼‰</div>
          <div style="color:var(--muted);font-size:13px">ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ï¼šè‡ªå‹•</div>
        </div>

        <textarea id="jsonInput" placeholder='ã“ã“ã« JSON ã‚’è²¼ã‚Šä»˜ã‘ â†’ ã€Œè²¼ã‚Šä»˜ã‘ã‹ã‚‰èª­ã¿è¾¼ã‚€ã€ã‚’æŠ¼ã—ã¾ã™'></textarea>
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button class="btn ghost" id="applyJson">åæ˜ ã™ã‚‹</button>
          <button class="btn" id="downloadJson">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
        </div>
      </div>
    </section>
  </div>
</div>

<!-- modal for image mapping -->
<div class="modal" id="imgModal">
  <div class="card">
    <h3>ç”»åƒãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆã‚¢ã‚¤ãƒ†ãƒ å â†’ ç”»åƒURL / ãƒ­ãƒ¼ã‚«ãƒ«ç”»åƒï¼‰</h3>
    <div id="imgMapList" style="max-height:50vh;overflow:auto;margin-top:8px"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
      <button class="btn ghost" id="closeImgModal">é–‰ã˜ã‚‹</button>
      <button class="btn" id="saveImgMap">ä¿å­˜</button>
    </div>
  </div>
</div>

<script>
/* Villager Catalog app
   - JSON structure assumed:
   {
     "å¸æ›¸": {
       "æ–°ç±³": {
         "ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰ã«ãªã‚‹ã‚‚ã®": [ { "item":"ç´™", "count":24, "emerald":1? } , ... ],
         "ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰ã§è²·ãˆã‚‹ã‚‚ã®": [ { "item":"æœ¬", "count":1, "emerald":2? } , ... ]
       },
       "è¦‹ç¿’ã„": { ... }
     },
     "è¾²æ°‘": { ... }
   }
*/
const STORAGE_KEY = 'villager_catalog_v1';
let db = JSON.parse(localStorage.getItem(STORAGE_KEY) || 'null') || {};
let imgMap = JSON.parse(localStorage.getItem(STORAGE_KEY + '_imgmap') || '{}');

const els = {
  jobList: document.getElementById('jobList'),
  levelTabs: document.getElementById('levelTabs'),
  currentJobLabel: document.getElementById('currentJobLabel'),
  sellList: document.getElementById('sellList'),
  buyList: document.getElementById('buyList'),
  jsonInput: document.getElementById('jsonInput'),
  search: document.getElementById('search'),
  fileInput: document.getElementById('fileInput'),
  countInfo: document.getElementById('countInfo'),
  imgModal: document.getElementById('imgModal'),
  imgMapList: document.getElementById('imgMapList')
};

let state = { job: null, level: null, filteredItems: [] };

/* helpers */
function saveDb(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(db)); }
function saveImgMap(){ localStorage.setItem(STORAGE_KEY + '_imgmap', JSON.stringify(imgMap)); }
function tryGetImage(itemName){
  // priority: explicit mapping -> try known CDN (not guaranteed offline) -> placeholder
  if(imgMap[itemName]) return imgMap[itemName];
  // fallback placeholder (SVG data URI with text)
  const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='64' height='64'><rect width='100%' height='100%' fill='#10292b'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-family='Arial' font-size='10' fill='#8fb9b0'>${escapeHtml(itemName).slice(0,8)}</text></svg>`;
  return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
}
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, (m)=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

/* render UI */
function renderJobs(){
  els.jobList.innerHTML = '';
  const jobs = Object.keys(db).sort((a,b)=> a.localeCompare(b,'ja'));
  if(jobs.length===0){
    els.jobList.innerHTML = `<div style="color:var(--muted)">è·æ¥­ãŒã‚ã‚Šã¾ã›ã‚“ã€‚JSONã‚’èª­ã¿è¾¼ã‚€ã‹ã€ã‚µãƒ³ãƒ—ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ã€‚</div>`;
    return;
  }
  jobs.forEach(j=>{
    const btn = document.createElement('button');
    btn.className = 'job-item';
    if(state.job === j) btn.classList.add('active');
    btn.textContent = j;
    btn.onclick = ()=> { state.job = j; state.level = null; renderLevels(); renderContent(); renderJobs(); };
    els.jobList.appendChild(btn);
  });
}

function renderLevels(){
  els.levelTabs.innerHTML = '';
  if(!state.job) { els.currentJobLabel.textContent = 'è·æ¥­ã‚’é¸æŠã—ã¦ãã ã•ã„'; return; }
  els.currentJobLabel.textContent = state.job;
  const levels = Object.keys(db[state.job] || {});
  levels.forEach(l=>{
    const b = document.createElement('button');
    b.className = 'level-btn' + (state.level===l? ' active':'');
    b.textContent = l;
    b.onclick = ()=> { state.level = l; renderContent(); renderLevels(); };
    els.levelTabs.appendChild(b);
  });
  // auto-select first level if none
  if(!state.level && levels.length) state.level = levels[0];
  // show count info
  els.countInfo.textContent = `levels: ${levels.length}`;
}

function renderContent(){
  els.sellList.innerHTML = '';
  els.buyList.innerHTML = '';
  if(!state.job || !state.level){ els.sellList.innerHTML = '<div style="color:var(--muted)">è·æ¥­ã¨ãƒ¬ãƒ™ãƒ«ã‚’é¸ã‚“ã§ãã ã•ã„</div>'; els.buyList.innerHTML = ''; return; }
  const node = db[state.job] && db[state.job][state.level];
  if(!node){ els.sellList.innerHTML = '<div style="color:var(--muted)">ãƒ‡ãƒ¼ã‚¿ãªã—</div>'; els.buyList.innerHTML = ''; return; }

  // items arrays may be arrays of objects or strings
  const sell = node['ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰ã«ãªã‚‹ã‚‚ã®'] || [];
  const buy = node['ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰ã§è²·ãˆã‚‹ã‚‚ã®'] || [];

  const q = (els.search.value || '').trim().toLowerCase();

  function renderList(arr, container, side){
    const list = Array.isArray(arr) ? arr : [];
    let shown = 0;
    list.forEach(it=>{
      // normalize
      let name = '', count = '', emerald = null;
      if(typeof it === 'string'){ name = it; count = ''; }
      else{ name = it.item || it.name || ''; count = it.count || it.qty || ''; emerald = (it.emerald!==undefined? it.emerald : it.cost || null); }
      if(q){
        const target = (name + ' ' + (it.note || '') + ' ' + (state.job || '') + ' ' + (state.level || '')).toLowerCase();
        if(!target.includes(q)) return;
      }
      shown++;
      const row = document.createElement('div'); row.className='item';
      const img = document.createElement('img'); img.className='thumb'; img.src = tryGetImage(name);
      const meta = document.createElement('div'); meta.className='itmeta';
      meta.innerHTML = `<div class="name">${escapeHtml(name)} ${count? (' Ã— '+escapeHtml(count)) : ''}</div>
                        <div class="sub">${emerald!==null? ('ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰: '+escapeHtml(String(emerald))) : ''}</div>`;
      const actions = document.createElement('div'); actions.className='it-actions';
      const setImgBtn = document.createElement('button'); setImgBtn.className='smallbtn'; setImgBtn.textContent='ç”»åƒè¨­å®š';
      setImgBtn.onclick = ()=> openImgEditor(name);
      const copyBtn = document.createElement('button'); copyBtn.className='smallbtn'; copyBtn.textContent='ã‚³ãƒ”ãƒ¼';
      copyBtn.onclick = ()=> { navigator.clipboard.writeText(`${name} ${count?('Ã—'+count):''} â†’ ${emerald!==null? emerald+' E':''}`); alert('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'); };
      actions.appendChild(setImgBtn); actions.appendChild(copyBtn);

      row.appendChild(img); row.appendChild(meta); row.appendChild(actions);
      container.appendChild(row);
    });
    if(shown===0) container.innerHTML = `<div style="color:var(--muted)">è©²å½“ã™ã‚‹å–å¼•ã¯ã‚ã‚Šã¾ã›ã‚“</div>`;
  }

  renderList(sell, els.sellList, 'sell');
  renderList(buy, els.buyList, 'buy');
}

/* import/export JSON */
function applyJsonText(txt){
  try{
    const obj = JSON.parse(txt);
    db = obj;
    saveDb();
    state.job = null; state.level = null;
    renderJobs(); renderLevels(); renderContent();
    alert('JSON ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜æ¸ˆã¿ï¼‰ã€‚');
  }catch(e){
    alert('JSON ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸï¼š' + e.message);
  }
}

/* file input */
els.fileInput.addEventListener('change', (ev)=>{
  const f = ev.target.files[0];
  if(!f) return;
  const fr = new FileReader();
  fr.onload = ()=> { applyJsonText(fr.result); els.fileInput.value = ''; };
  fr.readAsText(f);
});

/* paste JSON button */
document.getElementById('pasteJsonBtn').addEventListener('click', ()=>{
  const txt = els.jsonInput.value.trim();
  if(!txt){ alert('JSON ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚'); return; }
  applyJsonText(txt);
});

/* apply json */
document.getElementById('applyJson').addEventListener('click', ()=>{
  const txt = els.jsonInput.value.trim();
  if(!txt){ alert('JSON ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚'); return; }
  applyJsonText(txt);
});

/* download JSON */
document.getElementById('downloadJson').addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(db, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='villager_catalog.json'; a.click(); URL.revokeObjectURL(url);
});

/* export button */
document.getElementById('exportJson').addEventListener('click', ()=>{
  const txt = JSON.stringify(db, null, 2);
  navigator.clipboard.writeText(txt).then(()=> alert('JSON ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'));
});

/* clear all */
document.getElementById('clearAll').addEventListener('click', ()=>{
  if(!confirm('å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿï¼ˆå¾©å…ƒä¸å¯ï¼‰')) return;
  db = {}; imgMap = {}; saveDb(); saveImgMap(); renderJobs(); renderLevels(); renderContent();
});

/* sample data */
document.getElementById('loadSample').addEventListener('click', ()=>{
  const sample = {
    "å¸æ›¸": {
      "æ–°ç±³": {
        "ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰ã«ãªã‚‹ã‚‚ã®": [
          {"item":"ç´™","count":24},
          {"item":"æœ¬","count":6}
        ],
        "ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰ã§è²·ãˆã‚‹ã‚‚ã®": [
          {"item":"æœ¬ã¨ç¾½ãƒšãƒ³","count":1,"emerald":1},
          {"item":"åœ°å›³","count":1,"emerald":2}
        ]
      },
      "é”äºº": {
        "ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰ã«ãªã‚‹ã‚‚ã®": [
          {"item":"ç´™","count":8},
          {"item":"ç¾½æ ¹","count":4}
        ],
        "ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰ã§è²·ãˆã‚‹ã‚‚ã®": [
          {"item":"ã‚¨ãƒ³ãƒãƒ£ãƒ³ãƒˆã•ã‚ŒãŸæœ¬","count":1,"emerald":12}
        ]
      }
    },
    "è¾²æ°‘": {
      "æ–°ç±³": {
        "ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰ã«ãªã‚‹ã‚‚ã®":[ {"item":"å°éº¦","count":20,"emerald":1} ],
        "ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰ã§è²·ãˆã‚‹ã‚‚ã®":[ {"item":"ãƒ‘ãƒ³","count":6,"emerald":1} ]
      }
    }
  };
  db = sample; saveDb(); state.job = null; state.level = null; renderJobs(); renderLevels(); renderContent();
  alert('ã‚µãƒ³ãƒ—ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚JSONã‚’ç·¨é›†ã—ã¦ç‹¬è‡ªãƒ‡ãƒ¼ã‚¿ã‚’åæ˜ ã§ãã¾ã™ã€‚');
});

/* search */
els.search.addEventListener('input', ()=> renderContent());

/* copy view */
document.getElementById('copyView').addEventListener('click', ()=>{
  // prepare a readable text of current view
  if(!state.job || !state.level){ alert('è·æ¥­ã¨ãƒ¬ãƒ™ãƒ«ã‚’é¸ã‚“ã§ãã ã•ã„'); return; }
  const node = db[state.job][state.level];
  const lines = [];
  lines.push(`${state.job} â€” ${state.level}`);
  lines.push('ã€å£²ã‚‹ã‚‚ã® â†’ ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰ã€‘');
  (node['ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰ã«ãªã‚‹ã‚‚ã®']||[]).forEach(it=>{
    const name = it.item || it.name || it;
    const c = it.count || it.qty || '';
    const e = it.emerald || it.cost || '';
    lines.push(`- ${name} ${c?('Ã—'+c):''} ${e?('â†’ '+e+'E'):''}`);
  });
  lines.push('ã€ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰ã§è²·ãˆã‚‹ã‚‚ã®ã€‘');
  (node['ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰ã§è²·ãˆã‚‹ã‚‚ã®']||[]).forEach(it=>{
    const name = it.item || it.name || it;
    const c = it.count || it.qty || '';
    const e = it.emerald || it.cost || '';
    lines.push(`- ${name} ${c?('Ã—'+c):''} ${e?('â† '+e+'E'):''}`);
  });
  navigator.clipboard.writeText(lines.join('\\n')).then(()=> alert('è¡¨ç¤ºå†…å®¹ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'));
});

/* image mapping modal */
document.getElementById('openImgMap').addEventListener('click', ()=> {
  openImgModal();
});

document.getElementById('closeImgModal').addEventListener('click', ()=> {
  els.imgModal.classList.remove('open');
});

document.getElementById('saveImgMap').addEventListener('click', ()=> {
  // read inputs and save imgMap
  const inputs = els.imgMapList.querySelectorAll('input[data-name]');
  inputs.forEach(inp=>{
    const name = inp.dataset.name;
    const val = inp.value.trim();
    if(val) imgMap[name] = val;
    else delete imgMap[name];
  });
  saveImgMap();
  els.imgModal.classList.remove('open');
  renderContent();
  alert('ç”»åƒãƒãƒƒãƒ—ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼ˆlocalStorageï¼‰');
});

function openImgModal(){
  els.imgMapList.innerHTML = '';
  // collect all item names from db
  const names = new Set();
  Object.keys(db).forEach(job=>{
    Object.keys(db[job]).forEach(level=>{
      (db[job][level]['ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰ã«ãªã‚‹ã‚‚ã®']||[]).forEach(it=> names.add(typeof it==='string'?it:(it.item||it.name)));
      (db[job][level]['ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰ã§è²·ãˆã‚‹ã‚‚ã®']||[]).forEach(it=> names.add(typeof it==='string'?it:(it.item||it.name)));
    });
  });
  if(names.size===0){ els.imgMapList.innerHTML = '<div style="color:var(--muted)">ã‚¢ã‚¤ãƒ†ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚JSON ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ã€‚</div>'; }
  Array.from(names).sort((a,b)=> a.localeCompare(b,'ja')).forEach(n=>{
    const row = document.createElement('div'); row.className='row';
    row.innerHTML = `<label style="min-width:120px">${escapeHtml(n)}</label>
      <input data-name="${escapeHtml(n)}" value="${imgMap[n]||''}" placeholder="ç”»åƒURL ã¾ãŸã¯ local base64 (ãƒ‰ãƒ©ãƒƒã‚°ä¸å¯) " style="flex:1" />
      <input type="file" accept="image/*" data-file="${escapeHtml(n)}" />`;
    els.imgMapList.appendChild(row);
    const fileInput = row.querySelector('input[type="file"]');
    const textInput = row.querySelector('input[data-name]');
    fileInput.addEventListener('change', (ev)=>{
      const f = ev.target.files[0];
      if(!f) return;
      const fr = new FileReader();
      fr.onload = ()=> { textInput.value = fr.result; };
      fr.readAsDataURL(f);
    });
  });
  els.imgModal.classList.add('open');
}

/* open editor for single item */
function openImgEditor(itemName){
  // quick modal that sets mapping for one item
  const val = imgMap[itemName] || '';
  const url = prompt(itemName + ' ã®ç”»åƒURL ã¾ãŸã¯ localç”»åƒï¼ˆé¸æŠOKï¼‰ã€‚ç©ºã«ã™ã‚‹ã¨å‰Šé™¤ã•ã‚Œã¾ã™ã€‚', val);
  if(url === null) return;
  if(url.trim()) imgMap[itemName] = url.trim();
  else delete imgMap[itemName];
  saveImgMap();
  renderContent();
}

/* open pasted JSON prompt */
document.getElementById('pasteJsonBtn').addEventListener('click', ()=> {
  const txt = document.getElementById('jsonInput').value.trim();
  if(!txt){ alert('å·¦ã®ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã« JSON ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚'); return; }
  applyJsonText(txt);
});

/* load from localStorage on startup */
(function init(){
  renderJobs(); renderLevels(); renderContent();
})();

/* keyboard: Ctrl+V into jsonInput (for convenience) */
document.addEventListener('keydown', (e)=> {
  if((e.ctrlKey||e.metaKey) && e.key.toLowerCase() === 'v') {
    // do nothing special â€” user can paste into area
  }
});
</script>
</body>
</html>
